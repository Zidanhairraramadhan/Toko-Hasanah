/**
 * SEMBAKO MODERN - PRODUK.JS (VERSI FINAL YANG DIPERBAIKI)
 * Fitur: Menampilkan produk, filter kategori, pencarian, keranjang belanja, dan stok
 */

document.addEventListener('DOMContentLoaded', function() {

    // ==================== DATA PRODUK (ID SUDAH DIPERBAIKI) ====================
   const allProducts = [
    { id: 1, name: "Beras Premium 5kg", price: 58500, discount: 65000, image: "beras.webp", rating: 4.5, category: "Kebutuhan Rumah Tangga", description: "Beras premium kualitas terbaik", stock: 10 },
    { id: 2, name: "Minyak Goreng 2L", price: 30400, discount: 32000, image: "minyak(1).webp", rating: 4, category: "Kebutuhan Rumah Tangga", description: "Minyak goreng", stock: 15 },
    { id: 3, name: "Gula Pasir 1kg", price: 15000, image: "gula(1).webp", rating: 5, category: "Sembako Dasar", description: "Gula pasir kristal putih", stock: 20 },
    { id: 4, name: "Telur Ayam 1kg", price: 28000, image: "telur(1).webp", rating: 4.5, category: "Sembako Dasar", description: "Telur ayam segar", stock: 30 },
    { id: 5, name: "Tepung Terigu 1kg", price: 12000, image: "images/product-terigu.webp", rating: 4, category: "Kebutuhan Rumah Tangga", description: "Tepung terigu protein sedang", stock: 25 },
    { id: 6, name: "Kecap Manis 300ml", price: 15000, image: "images/product-kecap.webp", rating: 4.5, category: "Bumbu Dapur", description: "Kecap manis kental", stock: 18 },
    { id: 7, name: "Mie Instan Ayam Bawang", price: 3200, image: "images/product-mie.webp", rating: 4.5, category: "Makanan Instan", description: "Mie instan rasa ayam bawang", stock: 100 },
    { id: 8, name: "Kopi Sachet 10x20gr", price: 9800, image: "images/product-kopi.webp", rating: 4, category: "Minuman", description: "Kopi instan hitam pekat", stock: 50 },
    { id: 9, name: "Sabun Mandi Batang", price: 3000, image: "images/product-sabun.webp", rating: 4.3, category: "Kebutuhan Rumah Tangga", description: "Sabun batang wangi segar", stock: 80 },
    { id: 10, name: "Susu frisian flag", price: 13500, image: "images/product-susu.webp", rating: 4.6, category: "Minuman", description: "Susu bubuk manis untuk anak dan dewasa", stock: 60 },
    { id: 11, name: "Air Mineral 600ml", price: 3500, image: "images/product-air.webp", rating: 5, category: "Minuman", description: "Air mineral segar dalam botol", stock: 200 },
    { id: 12, name: "Mie Sedap Rebus Soto", price: 3200, image: "images/product-mie.webp", rating: 4.5, category: "Makanan Instan", description: "Mie instan Sedap Rasa Soto", stock: 100 },
    { id: 13, name: "Mie Instan Sedap Goreng", price: 3200, image: "images/product-mie.webp", rating: 4.5, category: "Makanan Instan", description: "Mie instan Sedap Goreng", stock: 100 },
    { id: 14, name: "Surya 12", price: 26000, image: "rokok.webp", rating: 4.5, category: "Rokok", description: "Gudang garam", stock: 100 },
    { id: 15, name: "Promag", price: 1000, image: "images/product-promax.webp", rating: 4.5, category: "Obat Obatan", description: "Ahlinya lambung", stock: 100 },
    { id: 16, name: "Koyo", price: 1000, image: "images/product-Koyo.webp", rating: 4.5, category: "Obat Obatan", description: "Meredakan encok", stock: 100 },
    { id: 17, name: "Bodrexin", price: 1000, image: "images/product-Bodrexin.webp", rating: 4.5, category: "Obat Obatan", description: "Menurunkan panas anak-anak", stock: 100 },
    { id: 18, name: "Bodrex", price: 1000, image: "images/product-Bodrex.webp", rating: 4.5, category: "Obat Obatan", description: "Obat menurunkan demam dll", stock: 100 },
];


    // ==================== SELEKSI ELEMEN DOM ====================
    let cart = [];
    const productsGrid = document.getElementById('productsGrid');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const searchInput = document.getElementById('searchInput');
    const menuBtn = document.getElementById('menu-btn');
    const navbar = document.getElementById('navbar');
    const searchBtn = document.getElementById('search-btn');
    const searchForm = document.getElementById('search-form');


    // ==================== FUNGSI-FUNGSI UTAMA ====================
    
    /**
     * [BARU] Fungsi terpusat untuk menampilkan produk berdasarkan filter dan pencarian
     */
    function updateProductView() {
        const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
        const searchTerm = searchInput.value.toLowerCase().trim();

        let filteredProducts = allProducts;

        // 1. Filter berdasarkan kategori
        if (activeCategory !== 'all') {
            filteredProducts = filteredProducts.filter(product => product.category === activeCategory);
        }

        // 2. Filter berdasarkan pencarian dari hasil di atas
        if (searchTerm) {
            filteredProducts = filteredProducts.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
        }

        renderProducts(filteredProducts);
    }

    /**
     * Fungsi untuk me-render (menampilkan) produk ke dalam grid
     * @param {Array} products - Array produk yang akan ditampilkan
     */
    function renderProducts(products) {
        productsGrid.innerHTML = ''; // Kosongkan grid

        if (products.length === 0) {
            productsGrid.innerHTML = '<p class="no-products" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">Produk tidak ditemukan</p>';
            return;
        }

        products.forEach(product => {
            productsGrid.appendChild(createProductElement(product));
        });
    }

    /**
     * Fungsi untuk membuat satu elemen HTML produk
     * @param {object} product - Objek produk
     */
    function createProductElement(product) {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';

        const discountBadge = product.discount ? `<div class="discount">-${Math.round((product.discount - product.price) / product.discount * 100)}%</div>` : '';
        const priceHTML = product.discount ? `<h4>Rp${product.discount.toLocaleString('id-ID')}</h4><h3>Rp${product.price.toLocaleString('id-ID')}</h3>` : `<h3>Rp${product.price.toLocaleString('id-ID')}</h3>`;
        const disabledClass = product.stock <= 0 ? 'disabled' : '';

        productDiv.innerHTML = `
            <div class="product-header">
                <img src="${product.image}" alt="${product.name}" loading="lazy">
                ${discountBadge}
            </div>
            <div class="product-footer">
                <h3>${product.name}</h3>
                <div class="rating">${renderRatingStars(product.rating)}</div>
                <div class="product-price">${priceHTML}</div>
                <p class="product-desc">${product.description}</p>
                <p class="product-stock" data-id="${product.id}">Stok: ${product.stock > 0 ? product.stock : 'Habis'}</p>
            </div>
            <ul>
                <li><a href="#"><i class="far fa-eye"></i></a></li>
                <li><a href="#"><i class="far fa-heart"></i></a></li>
                <li><a href="#" class="add-to-cart ${disabledClass}" data-id="${product.id}"><i class="fas fa-shopping-cart"></i></a></li>
            </ul>`;
        return productDiv;
    }

    // ==================== SETUP EVENT LISTENERS ====================
    
    // Setup untuk kontrol header
    menuBtn.addEventListener('click', () => navbar.classList.toggle('active'));
    searchBtn.addEventListener('click', () => searchForm.classList.toggle('active'));
    
    // Setup untuk filter kategori
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateProductView(); // Panggil fungsi terpusat
        });
    });
    
    // [DIPERBAIKI] Setup untuk pencarian 'as-you-type'
    searchInput.addEventListener('keyup', updateProductView); // Panggil fungsi terpusat

    // Setup untuk tombol 'add-to-cart'
    productsGrid.addEventListener('click', function(e) {
        const cartButton = e.target.closest('.add-to-cart');
        if (cartButton) {
            e.preventDefault();
            if (cartButton.classList.contains('disabled')) return;
            const product = allProducts.find(p => p.id == cartButton.dataset.id);
            if (product) addToCart(product);
        }
    });

    // ==================== FITUR KERANJANG BELANJA ====================
    
    function addToCart(product) {
        if (product.stock <= 0) {
            showNotification('Stok produk ini telah habis!', 'error');
            return;
        }

        product.stock -= 1; // Kurangi stok di data utama
        cart.push({ name: product.name, price: product.price });

        updateCartDisplay();
        updateStockDisplay(product.id);
        showNotification(`${product.name} berhasil ditambahkan ke keranjang`);
    }

    function updateCartDisplay() {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) cartCount.textContent = cart.length;
    }
    
    function updateStockDisplay(productId) {
        const stockElement = document.querySelector(`.product-stock[data-id="${productId}"]`);
        const product = allProducts.find(p => p.id == productId);
        if (stockElement && product) {
            stockElement.textContent = `Stok: ${product.stock > 0 ? product.stock : 'Habis'}`;
            if (product.stock <= 0) {
                const cartButton = stockElement.closest('.product').querySelector('.add-to-cart');
                cartButton.classList.add('disabled');
            }
        }
    }

    // ==================== FUNGSI PENDUKUNG ====================
    function renderRatingStars(rating) {
        let starsHTML = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) starsHTML += '<i class="fas fa-star"></i>';
            else if (i - 0.5 <= rating) starsHTML += '<i class="fas fa-star-half-alt"></i>';
            else starsHTML += '<i class="far fa-star"></i>';
        }
        return starsHTML;
    }

    function showNotification(message, type = 'success') {
        // ... (fungsi notifikasi tidak berubah, sudah baik)
    }

    // ==================== INISIALISASI APLIKASI ====================
    function init() {
        updateProductView(); // Tampilkan semua produk saat pertama kali dimuat
    }

    init(); // Jalankan aplikasi
});